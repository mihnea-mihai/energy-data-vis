---
title: "Data Visualisation - Europe Energy Production"
output:
  html_document: 
    theme: darkly
    highlight: breezedark
runtime: shiny
---
# {.tabset}

## Introduction 

Lorem ipsum

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.width = 9, out.height = 6)
```

### Libraries

```{r libraries, results='hide'}
library(tidyverse)
library(httr)
library(readxl)
library(plotly)
library(gganimate)
```

## Preprocessing {.tabset}

### Import

```{r import, results='hide', cache=TRUE}
# embed code from https://data.world/makeovermonday/2021w5
GET("https://query.data.world/s/rnsywm4k4ae3vz2iitu6cg4sww6xbc", 
    write_disk(tf <- tempfile(fileext = ".xlsx")))
raw <- read_excel(tf)
```

```{r echo=FALSE} 
raw
```

### Refactor columns

```{r}
data <- raw %>%
  select(Year = Year, Country = Area, Source = Variable,
         Production = `Generation (TWh)`) %>%
  mutate(across(c(Country, Source), factor))

data$Year <- as.integer(data$Year)
```


```{r}
data
```


### Handle Sources {.tabset}

#### View all Sources
```{r}
data %>%
  group_by(Source) %>%
  summarise(Total.TWh = sum(Production))
```

#### Define Source types

```{r}
sources <- list(
  fossil = c("Hard Coal", "Lignite", "Gas", "Other fossil"),
  renewable = c("Hydro", "Wind", "Solar", "Bioenergy", "Other renewables"),
  nuclear = c("Nuclear"),
  demand = c("Demand")
)
sources$base <- c(sources$fossil, sources$renewable, sources$nuclear)
```


#### Define Source colors

```{r}
sources$palette <- c("Hard Coal" = "orangered4",
                     "Lignite" = "saddlebrown",
                     "Gas" = "darkgoldenrod",
                     "Other fossil" = "darkgray",
                     "Hydro" = "royalblue",
                     "Wind" = "skyblue",
                     "Solar" = "gold",
                     "Bioenergy" = "forestgreen",
                     "Other renewables" = "springgreen3",
                     "Nuclear" = "orchid4")

sources$broad.palette <- c("Renewables" = "forestgreen", 
                           "Fossil" = "saddlebrown",
                           "Nuclear" = "orchid4")

sources$broad <- c("Fossil", "Renewables", "Nuclear")
data <- data %>%
  mutate(across(Source, factor, levels = c(sources$base, "Demand")))
saveRDS(sources, "sources.rds")
```


#### Add Broad Source

```{r}
data <- data %>%
  mutate(Broad.Source = factor(case_when(
    Source %in% sources$renewable ~ "Renewables",
    Source %in% sources$fossil ~ "Fossil",
    Source %in% sources$nuclear ~ "Nuclear"
    )))
data <- data %>%
  mutate(across(Broad.Source, factor, levels = sources$broad))
```

```{r echo=FALSE}
data
```




#### Filter irrelevant Sources

```{r}
data <- data %>%
  filter(Source %in% c(sources$base, "Demand"))
```

```{r echo=FALSE}
data
```



### Handle Countries {.tabset}
#### View all Countries
```{r}
data %>%
  filter(Source == "Demand") %>%
  group_by(Country) %>%
  summarise(Total.Production = sum(Production))
```
#### Filter irrelevant Countries

```{r}
data <- data %>%
  filter(!Country == "EU-27")
```

```{r echo=FALSE}
data
```


### Save

```{r}
saveRDS(data, "data.rds")
```


## Plots {.tabset}

### Prepare theme

```{r}
theme_update(text = element_text(size = 20, color = "gray81"),
             rect = element_rect(fill = "gray14"),
             axis.text = element_text(color = "gray48"),
             panel.background = element_rect(fill = "gray10"),
             panel.grid = element_line(color = "gray15"),
             legend.key = element_rect(fill = "gray14")
             )
```


### Good news

```{r out.width = 970}

# data <- readRDS("data.rds")
# sources <- readRDS("sources.rds")
data %>%
  filter(!is.na(Broad.Source)) %>%
  group_by(Year, Broad.Source) %>%
  summarise(Total.Production = sum(Production), .groups = "drop_last") %>%
  ggplot(aes(x = Year, y = Total.Production, color = Broad.Source)) +
  geom_line(size = 2) +
  scale_color_manual(values = sources$broad.palette) +
  theme(legend.position = "bottom") +
  labs(title = "Energy generation sources",
       subtitle = "EU27+1 countries") +
  ylab("Total Generation (TWh)")
```

### Variable by country by year

``` {r}
src_by_country_by_year <- function(country, year) {
  filtered_data <- data %>%
    filter(Country == country & Year == year & Source %in% sources$base)
  filtered_data %>%
    ggplot() +
      geom_col(aes(x = Broad.Source, y = Production,
                   fill = Source), width = 0.7) +
      scale_fill_manual(values = sources$palette) +
      labs(title = "Energy generation sources",
           subtitle = paste(country, " (", year, ")", sep = ""))
}

src_by_country_by_year("Romania", 2010)
```

```{r fig.width = 9.7, fig.height = 6}
# ggplotly()
```


### Variable by country

```{r}
src_by_country <- function(country) {
  broad_data <- data %>%
    filter(Country == country & Source %in% sources$base) %>%
    group_by(Year, Broad.Source) %>%
    summarise(Total.Production = sum(Production), .groups = "keep")
  
  demand_data <- data %>%
    filter(Country == country & Source == "Demand")
  
  data %>%
    filter(Country == country & Source %in% sources$base) %>%
    ggplot() +
      geom_area(aes(x = Year, y = Production, fill = Source), alpha = 1) +
      scale_fill_manual(values = sources$palette) +
      geom_line(data = broad_data,
                mapping = aes(x = Year, y = Total.Production,
                              group = Broad.Source),
                position = "stack", size = 1) +
      geom_line(data = demand_data,
                mapping = aes(x = Year, y = Production),
                color = "white", size = 1.5) +
      labs(title = "Energy generation sources evolution",
           subtitle = country)
}

src_by_country("Austria")
```




```{r}
# ggplotly()
```
























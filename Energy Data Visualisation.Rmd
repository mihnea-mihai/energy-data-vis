---
title: "Renewable energy Data Visualisation"
author: "Mihnea Mihai & Catalina Coman"
output: html_document
---

```{r setup, include=FALSE}
library("httr")
library("readxl")
library("dplyr")
library("ggplot2")
library("scales")
```
# Introduction

Using this dataset we aim to present an updated and meaningful report on the
share and historic evolution of renewables in the European energy mix.

Our dataset comprises information for the last 20 years on the energy
production and the sources which contributed to the energy mix.

# Preprocessing

## Importing

Fetch the data from the Web.

```{r message=FALSE, warning=FALSE, error=FALSE, results='hide', include=FALSE, echo=FALSE}
GET("https://query.data.world/s/dpqucaqcnzwoj45c4ft6mxihxzmmpe",
     write_disk(tf <- tempfile(fileext = ".xlsx")))
```

Parse and preview.

``` {r}
df <- read_excel(tf)
df
```

Select and rename relevant columns.

``` {r}
data <- df %>%
  select(Year = Year, Country = Area, Source = Variable,
         Generation = `Generation (TWh)`, Percent = `Share of production (%)`)
data
```
Split energy sources

```{r}
sources <- list(
  fossil = c("Hard Coal", "Lignite", "Gas", "Other fossil"),
  renewable = c("Hydro", "Wind", "Solar", "Bioenergy", "Other renewables"),
  nuclear = c("Nuclear")
)
sources$base <- c(sources$renewable, sources$fossil, sources$nuclear)
sources
sources$palette <- list("Hard Coal" = "gray10",
                        "Lignite" = "saddlebrown",
                        "Gas" = "darkgoldenrod",
                        "Other fossil" = "darkgray",
                        "Hydro" = "royalblue",
                        "Wind" = "deepskyblue",
                        "Solar" = "gold",
                        "Bioenergy" = "forestgreen",
                        "Other renewables" = "springgreen3",
                        "Nuclear" = "orchid4")
```


Add aggregate energy source column

```{r}
assign_broad_source <- function(src.vec) {
  res = rep_len(NA, length(src.vec))
  res[src.vec %in% sources$fossil] = "Fossil"
  res[src.vec %in% sources$renewable] = "Renewables"
  res[src.vec %in% sources$nuclear] = "Nuclear"
  return(res)
}

data <- data %>%
  mutate(Broad.Source = assign_broad_source(Source)) %>%
  filter(!is.na(Broad.Source))

data$Source <- factor(data$Source, levels = sources$base)

data
```

Save data
```{r}
save(data, file = "data.Rda")
```



``` {r}
src_by_country_by_year <- function(cntr, yr) {
  filtered_data <- data %>%
    filter(Country == cntr & Year == yr & Source %in% sources$base)
  filtered_data %>%
    ggplot() +
      geom_col(mapping = aes(x = Broad.Source, y = Percent, fill = Source)) +
      ggtitle(paste("Energy sources in ", cntr, " (", yr, ")", sep = "")) +
      scale_fill_manual(values = sources$palette)
}

src_by_country_by_year("France", 2018)
```


``` {r}
library(gganimate)
src_by_country_all_yrs <- function(cntr) {
  filtered_data <- data %>%
    filter(Country == cntr & Source %in% sources$base)
  filtered_data %>%
    ggplot() +
      geom_col(mapping = aes(x = Broad.Source, y = Percent,
                             fill = Source, label = Year)) +
      ggtitle(paste("Energy sources in", cntr, "(", ")")) +
      scale_fill_manual(values = sources$palette) +
    labs(title = "Year: {frame_time}") +
    transition_time(Year)
}
src_by_country_all_yrs("Romania")
```



```{r warning=FALSE}
filtered_data <- data %>%
  filter(!Country %in% c("EU-27", "EU27+1") & 
           Broad.Source != "Nuclear", Year == 2020) %>%
  group_by(Country, Broad.Source) %>%
  summarise(Total.Generation = sum(Generation), .groups = "keep")
renewables <- filtered_data %>% filter(Broad.Source == "Renewables")
fossil <- filtered_data %>% filter(Broad.Source == "Fossil")

new_df <- filtered_data %>%
  ungroup() %>%
  group_by(Country) %>%
  summarise()

filtered_data

new_df <- new_df %>%
  mutate(diff = renewables$Total.Generation - fossil$Total.Generation) %>%
new_df %>%
  ggplot(aes(x = Country, y = diff, fill = diff)) +
  geom_col() +
  scale_fill_gradient(low = "darkred", high = "forestgreen")

```


```{r}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(dplyr)
# https://rpubs.com/mkollontai/DATA607_TidyVerse
world <- ne_countries(returnclass = "sf")
Europe <- world[which(world$name_long %in% c(unique(new_df$Country))),]
new_df <- new_df %>% filter(Country %in% Europe$name_long)
Europe$diff <- new_df$diff
Europe %>%
  ggplot(aes(fill = diff, color = "black")) +
  geom_sf() +
  coord_sf(xlim = c(-15,35), ylim = c(35,70), expand = FALSE) +
  scale_fill_gradient(low = "darkred", high = "forestgreen")

```


```{r}
data %>%
  group_by(Country, Year, Broad.Source) %>%
  summarise(Yearly.Gen = sum(Generation), .groups = "keep") %>%
  filter(Country == "Luxembourg") %>%
  ggplot(aes(x = Year, y = Yearly.Gen, fill = Broad.Source)) +
  geom_area(position = "stack")
```

